server {
    listen 9123;
    server_name _;

    underscores_in_headers on;

    location /health {
        access_log off;
        return 200 'healthy';
    }

    location / {
        lua_need_request_body on;

        content_by_lua_block {
            local cjson = require "cjson.safe"

            -- Extract request details
            local headers = ngx.req.get_headers()
            local method = ngx.req.get_method()
            local uri = ngx.var.uri
            local query = ngx.var.args or ""
            local body = ngx.req.get_body_data()

            -- Parse query params into API Gateway v2 format
            local args = ngx.req.get_uri_args()
            local query_params = {}

            for k, v in pairs(args) do
                -- API Gateway v2 always uses string values
                if type(v) == "table" then
                    query_params[k] = v[#v]   -- take last value if multi
                else
                    query_params[k] = tostring(v)
                end
            end

            -- Extract path parameter
            local persisted_person = nil
            local m = ngx.re.match(uri, [[^/patient-check/([^/]+)$]])
            if m then
                persisted_person = m[1]
            end

            -- Build API Gateway v2 event
            local event = {
                version = "2.0",
                routeKey = method .. " /patient-check/{persisted_person}",
                rawPath = uri,
                rawQueryString = query,
                headers = headers,
                queryStringParameters = next(query_params) and query_params or nil,
                pathParameters = persisted_person and { persisted_person = persisted_person } or {},
                requestContext = {
                    http = {
                        method = method,
                        path = uri,
                        protocol = "HTTP/1.1",
                        sourceIp = ngx.var.remote_addr
                    }
                },
                body = body,
                isBase64Encoded = false
            }

            local json = cjson.encode(event)

            -- Invoke Lambda RIE
            local res = ngx.location.capture(
                "/invoke_lambda",
                {
                    method = ngx.HTTP_POST,
                    body = json,
                    ctx = {}
                }
            )

            if not res or not res.body then
                ngx.status = 502
                ngx.say("Lambda invocation failed")
                return ngx.exit(ngx.status)
            end

            -- Decode Lambda proxy response
            local lambda_resp = cjson.decode(res.body)
            if not lambda_resp then
                ngx.status = 502
                ngx.say("Invalid Lambda JSON: ", res.body)
                return ngx.exit(ngx.status)
            end

            -- Set HTTP status
            ngx.status = lambda_resp.statusCode or 200

            -- Set headers
            if lambda_resp.headers then
                for k, v in pairs(lambda_resp.headers) do
                    ngx.header[k] = v
                end
            end

            -- Write body
            ngx.say(lambda_resp.body)

            return ngx.exit(ngx.status)
        }
    }

    location /invoke_lambda {
        proxy_pass http://lambda-api:8080/2015-03-31/functions/function/invocations;
        proxy_read_timeout 30s;
    }
}
