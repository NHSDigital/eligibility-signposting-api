services:
  moto-server:
    image: motoserver/moto:latest
    container_name: moto-server
    ports:
      - "4566:5000"
    networks:
      - test-network

  sam-api:
    image: public.ecr.aws/sam/build-python3.13:latest
    container_name: sam-api
    command:
      - sam
      - local
      - start-api
      - --host
      - 0.0.0.0
      - --template
      - tests/template.yaml
      - --env-vars
      - tests/locals.json
      - --docker-network
      - tests_test-network
      # Force SAM to use the host gateway to find the Lambda container
      - --container-host
      - host.docker.internal
      - --container-host-interface
      - 0.0.0.0
    volumes:
      - ..:/var/opt:ro
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: /var/opt
    ports:
      - "3000:3000"
    environment:
      - AWS_ACCESS_KEY_ID=testing
      - AWS_SECRET_ACCESS_KEY=testing
      - AWS_DEFAULT_REGION=eu-west-1
      # Give it more breathing room for the handshake
      - SAM_CLI_CONTAINER_CONNECTION_TIMEOUT=60
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - moto-server
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
