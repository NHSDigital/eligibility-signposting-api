services:
  moto-server:
    image: motoserver/moto:latest
    container_name: moto-server
    ports:
      - "4566:5000"
    networks:
      - test-network

  sam-api:
    image: public.ecr.aws/sam/build-python3.13:latest
    container_name: sam-api
    command:
      - sam
      - local
      - start-api
      - --host
      - 0.0.0.0
      - --template
      - tests/template.yaml
      - --env-vars
      - tests/locals.json
      - --docker-network
      - tests_test-network
      - --container-host
      - host.docker.internal
      - --container-host-interface
      - 0.0.0.0
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      # Mount project root to /var/opt inside the container
      - ${PWD}/..:/var/opt:ro
      # CRITICAL: Create a 'tmp' folder in your 'tests' directory and mount it to /tmp
      - ${PWD}/tmp:/tmp:rw
    working_dir: /var/opt
    ports:
      - "3000:3000"
    environment:
      - AWS_ACCESS_KEY_ID=testing
      - AWS_SECRET_ACCESS_KEY=testing
      - AWS_DEFAULT_REGION=eu-west-1
      # Tell SAM the host's absolute path for the Zip and the shared /tmp
      - SAM_DOCKER_VOLUME_BASEDIR=/Users/karthikeyanthangavel/PycharmProjects/eligibility-signposting-api
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - moto-server
    networks:
      - test-network

networks:
  test-network:
    driver: bridge
