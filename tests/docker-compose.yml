services:
  moto-server:
    image: motoserver/moto:latest
    ports:
      - "4567:5000"
    environment:
      - MOTO_PORT=5000
    networks:
      - test-network
    healthcheck:
      test: "curl -f http://localhost:5000/health || exit 1"
      interval: 5s
      timeout: 5s
      retries: 5

  mock-fargate-server:
    build:
      context: ..
      dockerfile: Dockerfile
    image: mock-fargate-server:local-test
    ports:
      - "5001:5000"  # Flask
    networks:
      - test-network
    healthcheck:
      test: "curl -f http://localhost:5000/patient-check/_status || exit 1"
      interval: 5s
      timeout: 5s
      retries: 10
    environment:
      - AWS_DEFAULT_REGION=eu-west-1
      - AWS_ACCESS_KEY_ID=fake
      - AWS_SECRET_ACCESS_KEY=fake
      - AWS_SECURITY_TOKEN=fake
      - AWS_SESSION_TOKEN=fake
      - AWS_XRAY_SDK_ENABLED=false
      - DYNAMODB_ENDPOINT=http://moto-server:5000
      - S3_ENDPOINT=http://moto-server:5000
      - SECRET_MANAGER_ENDPOINT=http://moto-server:5000
      - FIREHOSE_ENDPOINT=http://moto-server:5000
      - LOG_LEVEL=INFO
    depends_on:
      - moto-server

    # This is your "API Gateway"
  mock-api-gateway:
      image: openresty/openresty:alpine # Using OpenResty for Lua support
      ports:
        - "9123:9123"
      volumes:
        - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      networks:
        - test-network

networks:
  test-network:
    driver: bridge
