name: "4. CD | Deploy to PreProd"

concurrency:
  group: preprod-deploy
  cancel-in-progress: false

on:
  workflow_run:
    workflows: ["3. CD | Deploy to Test"]
    types: [completed]
  workflow_dispatch:
    inputs:
      ref:
        description: "dev-* tag to deploy to PreProd"
        required: true
      release_type:
        description: "rc|patch|minor|major"
        required: true
        default: "rc"
      allow_older:
        description: "Allow deploying older than latest tested on main?"
        required: false
        type: choice
        options: ["false","true"]
        default: "false"
      reason:
        description: "Why are you doing a manual deployment?"
        required: true
        default: "To roll back to a previous commit"

permissions:
  contents: read
  actions: read

jobs:
  metadata:
    name: "Resolve ref + stale guard + release type"
    runs-on: ubuntu-latest
    outputs:
      ref:          ${{ steps.resolver.outputs.this_ref }}
      this_sha:     ${{ steps.resolver.outputs.this_sha }}
      latest_sha:   ${{ steps.resolver.outputs.latest_test_sha }}
      release_type: ${{ steps.release_type.outputs.release_type }}

    steps:
      - name: Checkout (full history & tags)
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Announce candidate ref
        id: announce
        shell: bash
        run: |
          set -euo pipefail
          git fetch --tags --force --quiet

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            HEAD="${{ github.event.workflow_run.head_sha }}"
            TAG="$(git tag --points-at "$HEAD" | grep '^dev-' | head -n1 || true)"
          else
            HEAD="$(git rev-list -n1 "${{ github.event.inputs.ref }}")"
            TAG="${{ github.event.inputs.ref }}"
          fi

          echo "CANDIDATE_TAG=$TAG"
          echo "CANDIDATE_SHA=$HEAD"

          # Nice UI hints
          echo "::notice title=PreProd candidate::dev tag: ${TAG} | sha: ${HEAD}"
          {
            echo "### PreProd candidate"
            echo ""
            echo "- dev tag: \`${TAG:-<none>}\`"
            echo "- head sha: \`${HEAD:-<none>}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Resolve THIS vs LATEST TEST + stale guard (auto only)
        id: resolver
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          EVENT_NAME: ${{ github.event_name }}
          WORKFLOW_RUN_HEAD_SHA: ${{ github.event.workflow_run.head_sha }}
          MANUAL_REF: ${{ github.event.inputs.ref }}
          ALLOW_OLDER: ${{ github.event.inputs.allow_older }}
          WORKFLOW_NAME: "3. CD | Deploy to Test"
          BRANCH: "main"
          LIMIT: "30"
        run: python3 scripts/pre-release_resolver.py

      - name: Resolve release_type (labels â†’ default rc)
        id: release_type
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH: "main"
          AGGREGATE: "true"
          THIS_SHA: ${{ steps.resolver.outputs.this_sha }}
          LATEST_TEST_SHA: ${{ steps.resolver.outputs.latest_test_sha }}
          MANUAL_RELEASE_TYPE: ${{ github.event.inputs.release_type }}
        run: python3 scripts/release_type_resolver.py

  deploy:
    name: "Call base-deploy.yml (PreProd)"
    needs: [metadata]
    uses: ./.github/workflows/base-deploy.yml
    with:
      environment: preprod
      ref:          ${{ needs.metadata.outputs.ref }}
      release_type: ${{ needs.metadata.outputs.release_type }}
    secrets: inherit
